# syntax=docker/dockerfile:1.7-labs

FROM ghcr.io/doctor-smith/gradle-base-frontend:latest AS build

WORKDIR /build

# ---- Step 1: Copy Gradle wrapper and build scripts only ----
COPY gradlew gradle/ ./

COPY settings.gradle.kts.frontend ./settings.gradle.kts
COPY build.gradle* gradle.properties ./
COPY buildSrc/build.gradle* buildSrc/settings.gradle* ./
COPY solawi-bid-api-data/build.gradle*  ./
COPY solawi-bid-frontend/build.gradle*  ./
COPY evoleq/build.gradle*  ./

# ---- Step 2: Pre-download dependencies for better caching ----
RUN --mount=type=cache,target=/home/gradle/.gradle \
    --mount=type=cache,target=/root/.gradle \
    --mount=type=cache,target=.gradle \
    ./gradlew --no-daemon --stacktrace --parallel --build-cache jsBrowserProductionWebpack -x test -x jsBrowserTest || true

# ---- Step 3: Copy the rest of the source code ----
COPY . .

# ---- Step 4: Build frontend without running browser tests ----
RUN --mount=type=cache,target=/home/gradle/.gradle \
    --mount=type=cache,target=/root/.gradle \
    --mount=type=cache,target=.gradle \
    ./gradlew --no-daemon --continue --parallel --build-cache \
      :solawi-bid-frontend:jsBrowserProductionWebpack -x jsBrowserTest \
      :solawi-bid-frontend:jsBrowserDistribution

# ---- Step 5: Run JS tests for selected subprojects ----
RUN --mount=type=cache,target=/home/gradle/.gradle \
    --mount=type=cache,target=/root/.gradle \
    --mount=type=cache,target=.gradle \
    ./gradlew --no-daemon --continue --parallel --build-cache \
      :solawi-bid-frontend:jsTest \
      :solawi-bid-api-data:jsTest \
      :evoleq:jsTest

# ---- Step 6: Collect test results ----
RUN mkdir -p /test-results && \
    cp -r /build/solawi-bid-frontend/build/test-results/. /test-results/ && \
    cp -r /build/solawi-bid-api-data/build/test-results/. /test-results/ && \
    cp -r /build/evoleq/build/test-results/. /test-results/

# ---- Final Stage ----
FROM nginx:1-alpine as production

ENV ENVIRONMENT="D"
ENV FRONTEND_URL="http://localhost"
ENV FRONTEND_PORT="8080"
ENV BACKEND_URL="http://localhost"
ENV BACKEND_PORT="8081"

COPY infrastructure/nginx/default.conf /etc/nginx/conf.d/default.conf
COPY --from=build /build/solawi-bid-frontend/build/dist/js/productionExecutable/ /usr/share/nginx/html
CMD ["sh", "-c", "envsubst < /usr/share/nginx/html/config.json.template > /usr/share/nginx/html/config.json && nginx -g 'daemon off;'"]
